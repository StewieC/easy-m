{% extends 'contributions/base.html' %}
{% block title %}{{ group.name }} - easy-m{% endblock %}
{% block content %}
<main>
    <section class="card">
        <h2 class="text-2xl font-semibold mb-4">{{ group.name }}</h2>
        <p class="mb-2">Type: {{ group.group_type }}</p>
        <p class="mb-2">Admin: {{ group.admin.username }}</p>
        <p class="mb-4">Total Contributions: KSH {{ group.total_contributions }}</p>

        {% if group.group_type == 'merry_go_round' %}
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Last Payout</h3>
            {% if last_payout %}
            <p>Payout of {{ last_payout.amount }} KSH to {{ last_payout.recipient.username }} on {{ last_payout.date }}</p>
            {% else %}
            <p>No payouts yet.</p>
            {% endif %}
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Next Payout</h3>
            {% if next_payout %}
            <p>Next payout of {{ next_payout.amount }} KSH to {{ next_payout.recipient.username }}.</p>
            {% else %}
            <p>No upcoming payouts scheduled.</p>
            {% endif %}
        </div>

        {% if user == group.admin %}
        <form method="post">
            {% csrf_token %}
            <button type="submit" name="make_payout" class="button">Make Payout</button>
        </form>
        {% endif %}
        {% endif %}

        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Contribution History</h3>
            {% if contributions %}
            <table>
                <thead>
                    <tr>
                        <th>Member</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contribution in contributions %}
                    <tr>
                        <td>{{ contribution.user.username }}</td>
                        <td>{{ contribution.amount }} KSH</td>
                        <td>{{ contribution.date|date:"D, d M Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No contributions have been made yet.</p>
            {% endif %}
        </div>

        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Make a Contribution</h3>
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <div class="flex space-x-2">
                    {{ form.amount }}
                    <button type="submit" name="contribute" class="button">Contribute</button>
                </div>
                {% if form.errors %}
                <div class="text-red-600">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </form>
        </div>

        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Members</h3>
            <ul class="space-y-2">
                {% for member in group.members.all %}
                <li class="card flex justify-between items-center">
                    <span>{{ member.username }}</span>
                    {% if user == group.admin and member != group.admin %}
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ member.id }}">
                        <button type="submit" name="remove_user" class="text-red-600 hover:text-red-800">Remove</button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

        {% if user == group.admin %}
        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Add Member</h3>
            <form method="post" class="flex space-x-2">
                {% csrf_token %}
                <input type="email" name="email" placeholder="Enter email" required>
                <button type="submit" name="add_user" class="button">Add</button>
            </form>
        </div>
        {% endif %}
    </section>
</main>
{% endblock %}